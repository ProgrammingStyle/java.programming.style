(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{331:function(t,v,_){"use strict";_.r(v);var s=_(33),c=Object(s.a)({},(function(){var t=this,v=t.$createElement,_=t._self._c||v;return _("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[_("h1",{attrs:{id:"五、mysql-数据库"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#五、mysql-数据库"}},[t._v("#")]),t._v(" 五、MySQL 数据库")]),t._v(" "),_("h2",{attrs:{id:"一-建表规约"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#一-建表规约"}},[t._v("#")]),t._v(" (一) 建表规约")]),t._v(" "),_("ol",[_("li",[_("p",[t._v("【强制】表达是与否概念的字段，必须使用 is_xxx 的方式命名，数据类型是 unsigned tinyint（ 1 表示是， 0 表示否）。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("任何字段如果为非负数，必须是 unsigned。\nPOJO 类中的任何布尔类型的变量，都不要加"),_("code",[t._v("is前缀")]),t._v("，所以，需要在"),_("code",[t._v("<resultMap>")]),t._v("设置从"),_("code",[t._v("is_xxx")]),t._v("到 "),_("code",[t._v("Xxx")]),t._v("的映射关系。数据库表示是与否的值，使用"),_("code",[t._v("tinyint")]),t._v("类型，坚持"),_("code",[t._v("is_xxx")]),t._v("的命名方式是为了明确其取值含义与取值范围。")])]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("正例：")]),t._v(" "),_("p",[t._v("表达逻辑删除的字段名"),_("code",[t._v("is_deleted")]),t._v("， "),_("code",[t._v("1")]),t._v(" 表示删除， "),_("code",[t._v("0")]),t._v(" 表示未删除。")])])]),t._v(" "),_("li",[_("p",[t._v("【强制】表名、字段名必须使用小写字母或数字，禁止出现数字开头，禁止两个下划线中间只出现数字。数据库字段名的修改代价很大，因为无法进行预发布，所以字段名称需要慎重考虑。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("MySQL 在 "),_("code",[t._v("Windows")]),t._v(" 下"),_("strong",[t._v("不区分大小写")]),t._v("，但在 "),_("code",[t._v("Linux")]),t._v(" 下默认是"),_("strong",[t._v("区分大小写")]),t._v("。因此，数据库名、表名、字段名，都不允许出现任何大写字母，避免节外生枝。")])]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("正例：")]),t._v(" "),_("p",[_("code",[t._v("aliyun_admin")]),t._v("，"),_("code",[t._v("rdc_config")]),t._v("，"),_("code",[t._v("level3_name")])])]),t._v(" "),_("div",{staticClass:"custom-block danger"},[_("p",{staticClass:"custom-block-title"},[t._v("反例：")]),t._v(" "),_("p",[_("code",[t._v("AliyunAdmin")]),t._v("，"),_("code",[t._v("rdcConfig")]),t._v("，"),_("code",[t._v("level_3_name")])])])]),t._v(" "),_("li",[_("p",[t._v("【强制】表名不使用复数名词。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("表名应该仅仅表示表里面的实体内容，不应该表示实体数量，对应于 "),_("code",[t._v("DO")]),t._v(" 类名也是单数形式，符合表达习惯。")])])]),t._v(" "),_("li",[_("p",[t._v("【强制】"),_("strong",[t._v("禁用保留字")]),t._v("，如 "),_("code",[t._v("desc")]),t._v("、"),_("code",[t._v("range")]),t._v("、"),_("code",[t._v("match")]),t._v("、"),_("code",[t._v("delayed")]),t._v(" 等，请参考 MySQL 官方保留字。")])]),t._v(" "),_("li",[_("p",[t._v("【强制】主键索引名为 "),_("code",[t._v("pk_字段名")]),t._v("；唯一索引名为 "),_("code",[t._v("uk_字段名")]),t._v("；普通索引名则为 "),_("code",[t._v("idx_字段名")]),t._v("。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[_("code",[t._v("pk_")]),t._v("即"),_("code",[t._v("primary key")]),t._v("；"),_("code",[t._v("uk_")]),t._v("即"),_("code",[t._v("unique key")]),t._v("；"),_("code",[t._v("idx_")]),t._v("即"),_("code",[t._v("index")]),t._v(" 的简称。")])])]),t._v(" "),_("li",[_("p",[t._v("【强制】小数类型为 "),_("code",[t._v("decimal")]),t._v("，禁止使用 "),_("code",[t._v("float")]),t._v(" 和 "),_("code",[t._v("double")]),t._v("。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("在存储的时候，"),_("code",[t._v("float")]),t._v(" 和 "),_("code",[t._v("double")]),t._v(" 都存在精度损失的问题，很可能在比较值的时候，得到不正确的结果。如果存储的数据范围超过 "),_("code",[t._v("decimal")]),t._v(" 的范围，建议将数据拆成整数和小数并分开存储。")])])]),t._v(" "),_("li",[_("p",[t._v("【强制】如果存储的字符串长度几乎相等，使用 "),_("code",[t._v("char")]),t._v(" 定长字符串类型。")])]),t._v(" "),_("li",[_("p",[t._v("【强制】"),_("code",[t._v("varchar")]),t._v(" 是可变长字符串，不预先分配存储空间，长度不要超过 "),_("code",[t._v("5000")]),t._v(" ，如果存储长度大于此值，定义字段类型为 "),_("code",[t._v("text")]),t._v("，独立出来一张表，用主键来对应，避免影响其它字段索引效率。")])]),t._v(" "),_("li",[_("p",[t._v("【强制】表必备三字段："),_("code",[t._v("id")]),t._v(", "),_("code",[t._v("gmt_create")]),t._v(", "),_("code",[t._v("gmt_modified")]),t._v("。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("其中 "),_("code",[t._v("id")]),t._v(" 必为主键，类型为 "),_("code",[t._v("bigint unsigned")]),t._v("、单表时自增、步长为 1 。")]),t._v(" "),_("p",[_("code",[t._v("gmt_create")]),t._v(", "),_("code",[t._v("gmt_modified")]),t._v(" 的类型均为 "),_("code",[t._v("datetime")]),t._v(" 类型，前者现在时表示主动式创建，后者过去分词表示被动式更新。")])])]),t._v(" "),_("li",[_("p",[t._v("【推荐】表的命名最好是遵循“"),_("code",[t._v("业务名称_表的作用")]),t._v("”。")]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("正例：")]),t._v(" "),_("p",[_("code",[t._v("alipay_task")]),t._v(" / "),_("code",[t._v("force_project")]),t._v(" / "),_("code",[t._v("trade_config")])])])]),t._v(" "),_("li",[_("p",[t._v("【推荐】库名与应用名称尽量一致。")])]),t._v(" "),_("li",[_("p",[t._v("【推荐】如果修改字段含义或对字段表示的状态追加时，需要及时更新字段注释。")])]),t._v(" "),_("li",[_("p",[t._v("【推荐】字段允许适当冗余，以提高查询性能，但必须考虑数据一致。冗余字段应遵循：")]),t._v(" "),_("p",[t._v("1 ） 不是频繁修改的字段。")]),t._v(" "),_("p",[t._v("2 ） 不是唯一索引的字段。")]),t._v(" "),_("p",[t._v("3 ） 不是 "),_("code",[t._v("varchar")]),t._v(" 超长字段，更不能是 "),_("code",[t._v("text")]),t._v(" 字段。")]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("正例：")]),t._v(" "),_("p",[t._v("各业务线经常冗余存储商品名称，避免查询时需要调用 "),_("code",[t._v("IC")]),t._v(" 服务获取。")])])]),t._v(" "),_("li",[_("p",[t._v("【推荐】单表行数超过 "),_("code",[t._v("500")]),t._v(" 万行或者单表容量超过 "),_("code",[t._v("2 GB")]),t._v("，才推荐进行分库分表。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("如果预计三年后的数据量根本达不到这个级别，请不要在创建表时就分库分表。")])])]),t._v(" "),_("li",[_("p",[t._v("【参考】合适的字符存储长度，不但节约数据库表空间、节约索引存储，更重要的是提升检索速度。")]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("正例：")]),t._v(" "),_("p",[t._v("无符号值可以避免误存负数，且扩大了表示范围。")]),t._v(" "),_("table",[_("thead",[_("tr",[_("th",{staticStyle:{"text-align":"center"}},[t._v("对象")]),t._v(" "),_("th",{staticStyle:{"text-align":"center"}},[t._v("年龄区间")]),t._v(" "),_("th",{staticStyle:{"text-align":"center"}},[t._v("类型")]),t._v(" "),_("th",{staticStyle:{"text-align":"center"}},[t._v("字节")]),t._v(" "),_("th",{staticStyle:{"text-align":"center"}},[t._v("表示范围")])])]),t._v(" "),_("tbody",[_("tr",[_("td",{staticStyle:{"text-align":"center"}},[t._v("人")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("150 岁之内")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("tinyint unsigned")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("无符号值： 0 到 255")])]),t._v(" "),_("tr",[_("td",{staticStyle:{"text-align":"center"}},[t._v("龟")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("数百岁")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("smallint unsigned")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("无符号值： 0 到 65535")])]),t._v(" "),_("tr",[_("td",{staticStyle:{"text-align":"center"}},[t._v("恐龙化石")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("数千万年")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("int unsigned")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("无符号值： 0 到约 43 亿")])]),t._v(" "),_("tr",[_("td",{staticStyle:{"text-align":"center"}},[t._v("太阳")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("约 50 亿年")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("bigint unsigned")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("8")]),t._v(" "),_("td",{staticStyle:{"text-align":"center"}},[t._v("无符号值： 0 到约 10 的 19 次方")])])])])])])]),t._v(" "),_("h2",{attrs:{id:"二-索引规约"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#二-索引规约"}},[t._v("#")]),t._v(" (二) 索引规约")]),t._v(" "),_("ol",[_("li",[_("p",[t._v("【强制】业务上具有唯一特性的字段，即使是组合字段，也必须建成唯一索引。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("不要以为唯一索引影响了 insert 速度，这个速度损耗可以忽略，但提高查找速度是明显的；另外，即使在应用层做了非常完善的校验控制，只要没有唯一索引，根据墨菲定律，必然有脏数据产生。")])])]),t._v(" "),_("li",[_("p",[t._v("【强制】超过三个表禁止 join。需要 join 的字段，数据类型保持绝对一致；多表关联查询时，保证被关联的字段需要有索引。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("即使双表 "),_("code",[t._v("join")]),t._v(" 也要注意表索引、SQL 性能。")])])]),t._v(" "),_("li",[_("p",[t._v("【强制】在 "),_("code",[t._v("varchar")]),t._v(" 字段上建立索引时，必须指定索引长度，没必要对全字段建立索引，根据实际文本区分度决定索引长度。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("索引的长度与区分度是一对矛盾体，一般对字符串类型数据，长度为 20 的索引，区分度会高达 90%以上，可以使用"),_("code",[t._v("count(distinct left(列名, 索引长度))/count(*)")]),t._v("的区分度来确定。")])])]),t._v(" "),_("li",[_("p",[t._v("【强制】页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("索引文件具有 B-Tree 的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索引。")])])]),t._v(" "),_("li",[_("p",[t._v("【推荐】如果有 "),_("code",[t._v("order by")]),t._v(" 的场景，请注意利用索引的有序性。"),_("code",[t._v("order by")]),t._v(" 最后的字段是组合索引的一部分，并且放在索引组合顺序的最后，避免出现 "),_("code",[t._v("file_sort")]),t._v(" 的情况，影响查询性能。")]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("正例：")]),t._v(" "),_("p",[_("code",[t._v("where a=? and b=? order by c; 索引：a_b_c")])])]),t._v(" "),_("div",{staticClass:"custom-block danger"},[_("p",{staticClass:"custom-block-title"},[t._v("反例：")]),t._v(" "),_("p",[t._v("索引如果存在范围查询，那么索引有序性无法利用，如："),_("code",[t._v("WHERE a>10 ORDER BY b")]),t._v("; 索引 "),_("code",[t._v("a_b")]),t._v(" 无法排序。")])])]),t._v(" "),_("li",[_("p",[t._v("【推荐】利用覆盖索引来进行查询操作，避免回表。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("如果一本书需要知道第 11 章是什么标题，会翻开第 11 章对应的那一页吗？目录浏览一下就好，这个目录就是起到覆盖索引的作用。")])]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("正例：")]),t._v(" "),_("p",[t._v("能够建立索引的种类分为主键索引、唯一索引、普通索引三种，而覆盖索引只是一种查询的一种效果，用 explain 的结果，extra 列会出现：using index。")])])]),t._v(" "),_("li",[_("p",[t._v("【推荐】利用延迟关联或者子查询优化超多分页场景。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("MySQL 并不是跳过 offset 行，而是取 offset+N 行，然后返回放弃前 offset 行，返回 N 行，那当 offset 特别大的时候，效率就非常的低下，要么控制返回的总页数，要么对超过特定阈值的页数进行 SQL 改写。")])]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("正例：")]),t._v(" "),_("p",[t._v("先快速定位需要获取的 id 段，然后再关联："),_("code",[t._v("SELECT a.\\* FROM 表 1 a, (select id from 表 1 where 条件 LIMIT 100000,20 ) b where a.id=b.id")])])])]),t._v(" "),_("li",[_("p",[t._v("【推荐】SQL 性能优化的目标：至少要达到 "),_("code",[t._v("range")]),t._v(" 级别，要求是 "),_("code",[t._v("ref")]),t._v(" 级别，如果可以是 "),_("code",[t._v("consts")]),t._v(" 最好。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("1 ） "),_("code",[t._v("consts")]),t._v(" 单表中最多只有一个匹配行（主键或者唯一索引），在优化阶段即可读取到数据。")]),t._v(" "),_("p",[t._v("2 ） "),_("code",[t._v("ref")]),t._v(" 指的是使用普通的索引（"),_("code",[t._v("normal index")]),t._v("）。")]),t._v(" "),_("p",[t._v("3 ） "),_("code",[t._v("range")]),t._v(" 对索引进行范围检索。")])]),t._v(" "),_("div",{staticClass:"custom-block danger"},[_("p",{staticClass:"custom-block-title"},[t._v("反例：")]),t._v(" "),_("p",[_("code",[t._v("explain")]),t._v(" 表的结果，"),_("code",[t._v("type=index")]),t._v("，索引物理文件全扫描，速度非常慢，这个 "),_("code",[t._v("index")]),t._v(" 级别比较 "),_("code",[t._v("range")]),t._v(" 还低，与全表扫描是小巫见大巫。")])])]),t._v(" "),_("li",[_("p",[t._v("【推荐】建组合索引的时候，区分度最高的在最左边。")]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("正例：")]),t._v(" "),_("p",[t._v("如果 "),_("code",[t._v("where a=? and b=?")]),t._v("，"),_("code",[t._v("a")]),t._v(" 列的几乎接近于唯一值，那么只需要单建 "),_("code",[t._v("idx_a")]),t._v(" 索引即可。")])]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("存在非等号和等号混合判断条件时，在建索引时，请把等号条件的列前置。如："),_("code",[t._v("where c>? and d=?")]),t._v(" 那么即使 "),_("code",[t._v("c")]),t._v(" 的区分度更高，也必须把 "),_("code",[t._v("d")]),t._v(" 放在索引的最前列，即建立组合索引 "),_("code",[t._v("idx_d_c")]),t._v("。")])])]),t._v(" "),_("li",[_("p",[t._v("【推荐】防止因字段类型不同造成的隐式转换，导致索引失效。")])]),t._v(" "),_("li",[_("p",[t._v("【参考】创建索引时避免有如下极端误解：")]),t._v(" "),_("p",[t._v("1 ） 索引宁滥勿缺。认为一个查询就需要建一个索引。")]),t._v(" "),_("p",[t._v("2 ） 吝啬索引的创建。认为索引会消耗空间、严重拖慢记录的更新以及行的新增速度。")]),t._v(" "),_("p",[t._v("3 ） 抵制惟一索引。认为惟一索引一律需要在应用层通过“先查后插”方式解决。")])])]),t._v(" "),_("h2",{attrs:{id:"三-sql-语句"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#三-sql-语句"}},[t._v("#")]),t._v(" (三) SQL 语句")]),t._v(" "),_("ol",[_("li",[_("p",[t._v("【强制】不要使用 "),_("code",[t._v("count(列名)")]),t._v(" 或 "),_("code",[t._v("count(常量)")]),t._v("来替代 "),_("code",[t._v("count(*)")]),t._v("，"),_("code",[t._v("count(*)")]),t._v("是 SQL92 定义的标\n准统计行数的语法，跟数据库无关，跟 "),_("code",[t._v("NULL")]),t._v(" 和"),_("code",[t._v("非 NULL")]),t._v(" 无关。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[_("code",[t._v("count(*)")]),t._v("会统计值为 "),_("code",[t._v("NULL")]),t._v(" 的行，而 "),_("code",[t._v("count(列名)")]),t._v("不会统计此列为 "),_("code",[t._v("NULL")]),t._v(" 值的行。")])])]),t._v(" "),_("li",[_("p",[t._v("【强制】"),_("code",[t._v("count(distinct col)")]),t._v(" 计算该列除 "),_("code",[t._v("NULL")]),t._v(" 之外的不重复行数，注意 "),_("code",[t._v("count(distinct col1, col2)")]),t._v(" 如果其中一列全为 "),_("code",[t._v("NULL")]),t._v("，那么即使另一列有不同的值，也返回为 "),_("code",[t._v("0")]),t._v(" 。")])]),t._v(" "),_("li",[_("p",[t._v("【强制】当某一列的值全是 "),_("code",[t._v("NULL")]),t._v(" 时，"),_("code",[t._v("count(col)")]),t._v("的返回结果为 "),_("code",[t._v("0")]),t._v(" ，但 "),_("code",[t._v("sum(col)")]),t._v("的返回结果为 "),_("code",[t._v("NULL")]),t._v("，因此使用 "),_("code",[t._v("sum()")]),t._v(" 时需注意 "),_("code",[t._v("NPE")]),t._v(" 问题。")]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("正例：")]),t._v(" "),_("p",[t._v("可以使用如下方式来避免 "),_("code",[t._v("sum")]),t._v(" 的 "),_("code",[t._v("NPE")]),t._v(" 问题："),_("code",[t._v("SELECT IFNULL(SUM(column), 0) FROM table;")])])])]),t._v(" "),_("li",[_("p",[t._v("【强制】使用 "),_("code",[t._v("ISNULL()")]),t._v(" 来判断是否为 "),_("code",[t._v("NULL")]),t._v(" 值。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[_("code",[t._v("NULL")]),t._v(" 与任何值的直接比较都为 "),_("code",[t._v("NULL")]),t._v("。")]),t._v(" "),_("p",[t._v("1 ） "),_("code",[t._v("NULL<>NULL")]),t._v(" 的返回结果是 "),_("code",[t._v("NULL")]),t._v("，而不是 "),_("code",[t._v("false")]),t._v("。")]),t._v(" "),_("p",[t._v("2 ） "),_("code",[t._v("NULL=NULL")]),t._v(" 的返回结果是 "),_("code",[t._v("NULL")]),t._v("，而不是 "),_("code",[t._v("true")]),t._v("。")]),t._v(" "),_("p",[t._v("3 ） "),_("code",[t._v("NULL<>1")]),t._v(" 的返回结果是 "),_("code",[t._v("NULL")]),t._v("，而不是 "),_("code",[t._v("true")]),t._v("。")])]),t._v(" "),_("div",{staticClass:"custom-block danger"},[_("p",{staticClass:"custom-block-title"},[t._v("反例：")]),t._v(" "),_("p",[t._v("在 SQL 语句中，如果在 null 前换行，影响可读性。")]),t._v(" "),_("p",[_("code",[t._v("select * from table where column1 is null and column3 is not null;")])]),t._v(" "),_("p",[t._v("而"),_("code",[t._v("ISNULL(column)")]),t._v("是一个整体，简洁易懂。从性能数据上分析，"),_("code",[t._v("ISNULL(column)")]),t._v(" 执行效率更快一些。")])])]),t._v(" "),_("li",[_("p",[t._v("【强制】代码中写分页查询逻辑时，若 "),_("code",[t._v("count")]),t._v(" 为 "),_("code",[t._v("0")]),t._v(" 应直接返回，避免执行后面的分页语句。")])]),t._v(" "),_("li",[_("p",[t._v("【强制】不得使用外键与级联，一切外键概念必须在应用层解决。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("（概念解释）学生表中的 "),_("code",[t._v("student_id")]),t._v(" 是主键，那么成绩表中的 "),_("code",[t._v("student_id")]),t._v(" 则为外键。如果更新学生表中的 "),_("code",[t._v("student_id")]),t._v("，同时触发成绩表中的 "),_("code",[t._v("student_id")]),t._v(" 更新，即为级联更新。")]),t._v(" "),_("p",[t._v("外键与级联更新适用于单机低并发，不适合分布式、高并发集群；")]),t._v(" "),_("p",[t._v("级联更新是强阻塞，存在数据库更新风暴的风险；外键影响数据库的插入速度。")])])]),t._v(" "),_("li",[_("p",[t._v("【强制】禁止使用存储过程，存储过程难以调试和扩展，更没有移植性。")])]),t._v(" "),_("li",[_("p",[t._v("【强制】数据订正（特别是删除或修改记录操作）时，要先 "),_("code",[t._v("select")]),t._v("，避免出现误删除，确认无误才能执行更新语句。")])]),t._v(" "),_("li",[_("p",[t._v("【强制】对于数据库中表记录的查询和变更，只要涉及多个表，都需要在列名前加表的别名（或表名）进行限定。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("对多表进行查询记录、更新记录、删除记录时，如果对操作列没有限定表的别名（或表名），并且操作列在多个表中存在时，就会抛异常。")])]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("正例：")]),t._v(" "),_("p",[_("code",[t._v("select t1.name from table_first as t1 , table_second as t2 where t1.id=t2.id;")])])]),t._v(" "),_("div",{staticClass:"custom-block danger"},[_("p",{staticClass:"custom-block-title"},[t._v("反例：")]),t._v(" "),_("p",[t._v("在某业务中，由于多表关联查询语句没有加表的别名（或表名）的限制，正常运行两年后，最近在某个表中增加一个同名字段，在预发布环境做数据库变更后，线上查询语句出现出 1052 异常："),_("code",[t._v("Column 'name' in field list is ambiguous")]),t._v("。")])])]),t._v(" "),_("li",[_("p",[t._v("【推荐】SQL 语句中表的别名前加 "),_("code",[t._v("as")]),t._v("，并且以 "),_("code",[t._v("t1、t2、t3、...")]),t._v("的顺序依次命名。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("1 ）别名可以是表的简称，或者是根据表出现的顺序，以 "),_("code",[t._v("t1、t2、t3")]),t._v(" 的方式命名。")]),t._v(" "),_("p",[t._v("2 ）别名前加 "),_("code",[t._v("as")]),t._v(" 使别名更容易识别。")])]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("正例：")]),t._v(" "),_("p",[_("code",[t._v("select t1.name from table_first as t1, table_second as t2 where t1.id=t2.id;")])])])]),t._v(" "),_("li",[_("p",[t._v("【推荐】in 操作能避免则避免，若实在避免不了，需要仔细评估 "),_("code",[t._v("in")]),t._v(" 后边的集合元素数量，控制在 "),_("code",[t._v("1000")]),t._v(" 个之内。")])]),t._v(" "),_("li",[_("p",[t._v("【参考】因国际化需要，所有的字符存储与表示，均采用 "),_("code",[t._v("utf8")]),t._v(" 字符集，那么字符计数方法需要注意。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v('SELECT LENGTH("轻松工作")； 返回为 12')]),t._v(" "),_("p",[t._v('SELECT CHARACTER_LENGTH("轻松工作")； 返回为 4')]),t._v(" "),_("p",[t._v("如果需要存储表情，那么选择 "),_("code",[t._v("utf8mb4")]),t._v(" 来进行存储，注意它与 "),_("code",[t._v("utf8")]),t._v(" 编码的区别。")])])]),t._v(" "),_("li",[_("p",[t._v("【参考】"),_("code",[t._v("TRUNCATE TABLE")]),t._v(" 比 "),_("code",[t._v("DELETE")]),t._v(" 速度快，且使用的系统和事务日志资源少，但 "),_("code",[t._v("TRUNCATE")]),t._v(" 无事务且不触发 "),_("code",[t._v("trigger")]),t._v("，有可能造成事故，故不建议在开发代码中使用此语句。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[_("code",[t._v("TRUNCATE TABLE")]),t._v(" 在功能上与不带 "),_("code",[t._v("WHERE")]),t._v(" 子句的 "),_("code",[t._v("DELETE")]),t._v(" 语句相同。")])])])]),t._v(" "),_("h2",{attrs:{id:"四-orm-映射"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#四-orm-映射"}},[t._v("#")]),t._v(" (四) ORM 映射")]),t._v(" "),_("ol",[_("li",[_("p",[t._v("【强制】在表查询中，一律不要使用 "),_("code",[t._v("*")]),t._v(" 作为查询的字段列表，需要哪些字段必须明确写明。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("1 ）增加查询分析器解析成本。")]),t._v(" "),_("p",[t._v("2 ）增减字段容易与 "),_("code",[t._v("resultMap")]),t._v(" 配置不一致。")]),t._v(" "),_("p",[t._v("3 ）无用字段增加网络消耗，尤其是 "),_("code",[t._v("text")]),t._v(" 类型的字段。")])])]),t._v(" "),_("li",[_("p",[t._v("【强制】POJO 类的布尔属性不能加 "),_("code",[t._v("is")]),t._v("，而数据库字段必须加 "),_("code",[t._v("is_")]),t._v("，要求在 "),_("code",[t._v("resultMap")]),t._v(" 中进行字段与属性之间的映射。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("参见定义 POJO 类以及数据库字段定义规定，在 "),_("code",[t._v("sql.xml")]),t._v(" 增加映射，是必须的。")])])]),t._v(" "),_("li",[_("p",[t._v("【强制】不要用 "),_("code",[t._v("resultClass")]),t._v(" 当返回参数，即使所有类属性名与数据库字段一一对应，也需要定义"),_("code",[t._v("<resultMap>")]),t._v("；反过来，每一个表也必然有一个"),_("code",[t._v("<resultMap>")]),t._v("与之对应。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("配置映射关系，使字段与 "),_("code",[t._v("DO")]),t._v(" 类解耦，方便维护。")])])]),t._v(" "),_("li",[_("p",[t._v("【强制】sql.xml 配置参数使用："),_("code",[t._v("#{}")]),t._v("，"),_("code",[t._v("#param#")]),t._v(" 不要使用"),_("code",[t._v("${}")]),t._v(" 此种方式容易出现 "),_("code",[t._v("SQL 注入")]),t._v("。")])]),t._v(" "),_("li",[_("p",[t._v("【强制】"),_("code",[t._v("iBATIS")]),t._v(" 自带的 "),_("code",[t._v("queryForList(String statementName,int start,int size)")]),t._v(" 不推荐使用。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("其实现方式是在数据库取到 "),_("code",[t._v("statementName")]),t._v(" 对应的 SQL 语句的所有记录，再通过 "),_("code",[t._v("subList")]),t._v(" 取 "),_("code",[t._v("start")]),t._v(","),_("code",[t._v("size")]),t._v(" 的子集合。")])]),t._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[t._v("正例：")]),t._v(" "),_("div",{staticClass:"language-java extra-class"},[_("pre",{pre:!0,attrs:{class:"language-java"}},[_("code",[_("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Map")]),_("span",{pre:!0,attrs:{class:"token generics"}},[_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),_("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" map "),_("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HashMap")]),_("span",{pre:!0,attrs:{class:"token generics"}},[_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nmap"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),_("span",{pre:!0,attrs:{class:"token function"}},[t._v("put")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),_("span",{pre:!0,attrs:{class:"token string"}},[t._v('"start"')]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" start"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nmap"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),_("span",{pre:!0,attrs:{class:"token function"}},[t._v("put")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),_("span",{pre:!0,attrs:{class:"token string"}},[t._v('"size"')]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" size"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])])]),t._v(" "),_("li",[_("p",[t._v("【强制】不允许直接拿 "),_("code",[t._v("HashMap")]),t._v(" 与 "),_("code",[t._v("Hashtable")]),t._v(" 作为查询结果集的输出。")]),t._v(" "),_("div",{staticClass:"custom-block danger"},[_("p",{staticClass:"custom-block-title"},[t._v("反例：")]),t._v(" "),_("p",[t._v("某同学为避免写一个"),_("code",[t._v("<resultMap>")]),t._v("，直接使用 "),_("code",[t._v("HashTable")]),t._v(" 来接收数据库返回结果，结果出现日常是把 "),_("code",[t._v("bigint")]),t._v(" 转成 "),_("code",[t._v("Long")]),t._v(" 值，而线上由于数据库版本不一样，解析成 "),_("code",[t._v("BigInteger")]),t._v("，导致线上问题。")])])]),t._v(" "),_("li",[_("p",[t._v("【强制】更新数据表记录时，必须同时更新记录对应的 "),_("code",[t._v("gmt_modified")]),t._v(" 字段值为当前时间。")])]),t._v(" "),_("li",[_("p",[t._v("【推荐】不要写一个大而全的数据更新接口。传入为 POJO 类，不管是不是自己的目标更新字段，都进行 "),_("code",[t._v("update table set c1=value1,c2=value2,c3=value3;")]),t._v(" 这是不对的。")]),t._v(" "),_("div",{staticClass:"custom-block warning"},[_("p",{staticClass:"custom-block-title"},[t._v("说明：")]),t._v(" "),_("p",[t._v("执行 SQL 时，不要更新无改动的字段")]),t._v(" "),_("ul",[_("li",[t._v("一是易出错；")]),t._v(" "),_("li",[t._v("二是效率低；")]),t._v(" "),_("li",[t._v("三是增加 "),_("code",[t._v("binlog")]),t._v(" 存储。")])])])]),t._v(" "),_("li",[_("p",[t._v("【参考】"),_("code",[t._v("@Transactional")]),t._v(" 事务不要滥用。事务会影响数据库的 QPS，另外使用事务的地方需要考虑各方面的回滚方案，包括"),_("code",[t._v("缓存回滚")]),t._v("、"),_("code",[t._v("搜索引擎回滚")]),t._v("、"),_("code",[t._v("消息补偿")]),t._v("、"),_("code",[t._v("统计修正")]),t._v("等。")])]),t._v(" "),_("li",[_("p",[t._v("【参考】"),_("code",[t._v("<isEqual>")]),t._v("中的 "),_("code",[t._v("compareValue")]),t._v(" 是与属性值对比的常量，一般是数字，表示相等时带上此条件；"),_("code",[t._v("<isNotEmpty>")]),t._v("表示不为"),_("code",[t._v("空")]),t._v("且不为 "),_("code",[t._v("null")]),t._v(" 时执行；"),_("code",[t._v("<isNotNull>")]),t._v("表示不为 "),_("code",[t._v("null")]),t._v(" 值时执行。")])])])])}),[],!1,null,null,null);v.default=c.exports}}]);