<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>五、MySQL 数据库 | Java 编程规范</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Java 代码整洁之道">
    <link rel="preload" href="/assets/css/0.styles.f69a04f2.css" as="style"><link rel="preload" href="/assets/js/app.ebef3189.js" as="script"><link rel="preload" href="/assets/js/2.6bb482e9.js" as="script"><link rel="preload" href="/assets/js/12.2916cd62.js" as="script"><link rel="prefetch" href="/assets/js/10.43cf8674.js"><link rel="prefetch" href="/assets/js/11.e3e93c84.js"><link rel="prefetch" href="/assets/js/13.e0e9bcc6.js"><link rel="prefetch" href="/assets/js/14.134f0f23.js"><link rel="prefetch" href="/assets/js/15.ebf872e0.js"><link rel="prefetch" href="/assets/js/16.97604c24.js"><link rel="prefetch" href="/assets/js/17.f0da6ac9.js"><link rel="prefetch" href="/assets/js/18.683dd516.js"><link rel="prefetch" href="/assets/js/19.ac74fe53.js"><link rel="prefetch" href="/assets/js/20.16fbc1d6.js"><link rel="prefetch" href="/assets/js/21.1613b491.js"><link rel="prefetch" href="/assets/js/22.532d3087.js"><link rel="prefetch" href="/assets/js/3.b925be4d.js"><link rel="prefetch" href="/assets/js/4.42e5e5a2.js"><link rel="prefetch" href="/assets/js/5.00bc1fc7.js"><link rel="prefetch" href="/assets/js/6.8cf3236e.js"><link rel="prefetch" href="/assets/js/7.ee76a0f8.js"><link rel="prefetch" href="/assets/js/8.52beb9ac.js"><link rel="prefetch" href="/assets/js/9.d93f00cf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f69a04f2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Java 编程规范</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/alibaba/" class="nav-link router-link-active">
  阿里规范
</a></div><div class="nav-item"><a href="/google/" class="nav-link">
  谷歌规范
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="选择语言" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/alibaba/mysql-database-specification.html" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/" class="nav-link">
  English
</a></li></ul></div></div> <a href="https://github.com/programmingStyle/java.programming.style" target="_blank" rel="noopener noreferrer" class="repo-link">
    Java Programming Style
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/alibaba/" class="nav-link router-link-active">
  阿里规范
</a></div><div class="nav-item"><a href="/google/" class="nav-link">
  谷歌规范
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="选择语言" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/alibaba/mysql-database-specification.html" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/" class="nav-link">
  English
</a></li></ul></div></div> <a href="https://github.com/programmingStyle/java.programming.style" target="_blank" rel="noopener noreferrer" class="repo-link">
    Java Programming Style
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java开发手册(泰山版)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/alibaba/" class="sidebar-link">前言</a></li><li><a href="/alibaba/java-specification.html" class="sidebar-link">一、 编程规约</a></li><li><a href="/alibaba/exception-log-specification.html" class="sidebar-link">二、异常日志</a></li><li><a href="/alibaba/unit-test-specification.html" class="sidebar-link">三、单元测试</a></li><li><a href="/alibaba/security-specification.html" class="sidebar-link">四、安全规约</a></li><li><a href="/alibaba/mysql-database-specification.html" class="active sidebar-link">五、MySQL 数据库</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/alibaba/mysql-database-specification.html#一-建表规约" class="sidebar-link">(一) 建表规约</a></li><li class="sidebar-sub-header"><a href="/alibaba/mysql-database-specification.html#二-索引规约" class="sidebar-link">(二) 索引规约</a></li><li class="sidebar-sub-header"><a href="/alibaba/mysql-database-specification.html#三-sql-语句" class="sidebar-link">(三) SQL 语句</a></li><li class="sidebar-sub-header"><a href="/alibaba/mysql-database-specification.html#四-orm-映射" class="sidebar-link">(四) ORM 映射</a></li></ul></li><li><a href="/alibaba/project-struct-specification.html" class="sidebar-link">六、工程结构</a></li><li><a href="/alibaba/design-specification.html" class="sidebar-link">七、设计规约</a></li><li><a href="/alibaba/appendix.html" class="sidebar-link">附录</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="五、mysql-数据库"><a href="#五、mysql-数据库" class="header-anchor">#</a> 五、MySQL 数据库</h1> <h2 id="一-建表规约"><a href="#一-建表规约" class="header-anchor">#</a> (一) 建表规约</h2> <ol><li><p>【强制】表达是与否概念的字段，必须使用 is_xxx 的方式命名，数据类型是 unsigned tinyint（ 1 表示是， 0 表示否）。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>任何字段如果为非负数，必须是 unsigned。
POJO 类中的任何布尔类型的变量，都不要加<code>is前缀</code>，所以，需要在<code>&lt;resultMap&gt;</code>设置从<code>is_xxx</code>到 <code>Xxx</code>的映射关系。数据库表示是与否的值，使用<code>tinyint</code>类型，坚持<code>is_xxx</code>的命名方式是为了明确其取值含义与取值范围。</p></div> <div class="custom-block tip"><p class="custom-block-title">正例：</p> <p>表达逻辑删除的字段名<code>is_deleted</code>， <code>1</code> 表示删除， <code>0</code> 表示未删除。</p></div></li> <li><p>【强制】表名、字段名必须使用小写字母或数字，禁止出现数字开头，禁止两个下划线中间只出现数字。数据库字段名的修改代价很大，因为无法进行预发布，所以字段名称需要慎重考虑。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>MySQL 在 <code>Windows</code> 下<strong>不区分大小写</strong>，但在 <code>Linux</code> 下默认是<strong>区分大小写</strong>。因此，数据库名、表名、字段名，都不允许出现任何大写字母，避免节外生枝。</p></div> <div class="custom-block tip"><p class="custom-block-title">正例：</p> <p><code>aliyun_admin</code>，<code>rdc_config</code>，<code>level3_name</code></p></div> <div class="custom-block danger"><p class="custom-block-title">反例：</p> <p><code>AliyunAdmin</code>，<code>rdcConfig</code>，<code>level_3_name</code></p></div></li> <li><p>【强制】表名不使用复数名词。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>表名应该仅仅表示表里面的实体内容，不应该表示实体数量，对应于 <code>DO</code> 类名也是单数形式，符合表达习惯。</p></div></li> <li><p>【强制】<strong>禁用保留字</strong>，如 <code>desc</code>、<code>range</code>、<code>match</code>、<code>delayed</code> 等，请参考 MySQL 官方保留字。</p></li> <li><p>【强制】主键索引名为 <code>pk_字段名</code>；唯一索引名为 <code>uk_字段名</code>；普通索引名则为 <code>idx_字段名</code>。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p><code>pk_</code>即<code>primary key</code>；<code>uk_</code>即<code>unique key</code>；<code>idx_</code>即<code>index</code> 的简称。</p></div></li> <li><p>【强制】小数类型为 <code>decimal</code>，禁止使用 <code>float</code> 和 <code>double</code>。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>在存储的时候，<code>float</code> 和 <code>double</code> 都存在精度损失的问题，很可能在比较值的时候，得到不正确的结果。如果存储的数据范围超过 <code>decimal</code> 的范围，建议将数据拆成整数和小数并分开存储。</p></div></li> <li><p>【强制】如果存储的字符串长度几乎相等，使用 <code>char</code> 定长字符串类型。</p></li> <li><p>【强制】<code>varchar</code> 是可变长字符串，不预先分配存储空间，长度不要超过 <code>5000</code> ，如果存储长度大于此值，定义字段类型为 <code>text</code>，独立出来一张表，用主键来对应，避免影响其它字段索引效率。</p></li> <li><p>【强制】表必备三字段：<code>id</code>, <code>gmt_create</code>, <code>gmt_modified</code>。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>其中 <code>id</code> 必为主键，类型为 <code>bigint unsigned</code>、单表时自增、步长为 1 。</p> <p><code>gmt_create</code>, <code>gmt_modified</code> 的类型均为 <code>datetime</code> 类型，前者现在时表示主动式创建，后者过去分词表示被动式更新。</p></div></li> <li><p>【推荐】表的命名最好是遵循“<code>业务名称_表的作用</code>”。</p> <div class="custom-block tip"><p class="custom-block-title">正例：</p> <p><code>alipay_task</code> / <code>force_project</code> / <code>trade_config</code></p></div></li> <li><p>【推荐】库名与应用名称尽量一致。</p></li> <li><p>【推荐】如果修改字段含义或对字段表示的状态追加时，需要及时更新字段注释。</p></li> <li><p>【推荐】字段允许适当冗余，以提高查询性能，但必须考虑数据一致。冗余字段应遵循：</p> <p>1 ） 不是频繁修改的字段。</p> <p>2 ） 不是唯一索引的字段。</p> <p>3 ） 不是 <code>varchar</code> 超长字段，更不能是 <code>text</code> 字段。</p> <div class="custom-block tip"><p class="custom-block-title">正例：</p> <p>各业务线经常冗余存储商品名称，避免查询时需要调用 <code>IC</code> 服务获取。</p></div></li> <li><p>【推荐】单表行数超过 <code>500</code> 万行或者单表容量超过 <code>2 GB</code>，才推荐进行分库分表。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>如果预计三年后的数据量根本达不到这个级别，请不要在创建表时就分库分表。</p></div></li> <li><p>【参考】合适的字符存储长度，不但节约数据库表空间、节约索引存储，更重要的是提升检索速度。</p> <div class="custom-block tip"><p class="custom-block-title">正例：</p> <p>无符号值可以避免误存负数，且扩大了表示范围。</p> <table><thead><tr><th style="text-align:center;">对象</th> <th style="text-align:center;">年龄区间</th> <th style="text-align:center;">类型</th> <th style="text-align:center;">字节</th> <th style="text-align:center;">表示范围</th></tr></thead> <tbody><tr><td style="text-align:center;">人</td> <td style="text-align:center;">150 岁之内</td> <td style="text-align:center;">tinyint unsigned</td> <td style="text-align:center;">1</td> <td style="text-align:center;">无符号值： 0 到 255</td></tr> <tr><td style="text-align:center;">龟</td> <td style="text-align:center;">数百岁</td> <td style="text-align:center;">smallint unsigned</td> <td style="text-align:center;">2</td> <td style="text-align:center;">无符号值： 0 到 65535</td></tr> <tr><td style="text-align:center;">恐龙化石</td> <td style="text-align:center;">数千万年</td> <td style="text-align:center;">int unsigned</td> <td style="text-align:center;">4</td> <td style="text-align:center;">无符号值： 0 到约 43 亿</td></tr> <tr><td style="text-align:center;">太阳</td> <td style="text-align:center;">约 50 亿年</td> <td style="text-align:center;">bigint unsigned</td> <td style="text-align:center;">8</td> <td style="text-align:center;">无符号值： 0 到约 10 的 19 次方</td></tr></tbody></table></div></li></ol> <h2 id="二-索引规约"><a href="#二-索引规约" class="header-anchor">#</a> (二) 索引规约</h2> <ol><li><p>【强制】业务上具有唯一特性的字段，即使是组合字段，也必须建成唯一索引。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>不要以为唯一索引影响了 insert 速度，这个速度损耗可以忽略，但提高查找速度是明显的；另外，即使在应用层做了非常完善的校验控制，只要没有唯一索引，根据墨菲定律，必然有脏数据产生。</p></div></li> <li><p>【强制】超过三个表禁止 join。需要 join 的字段，数据类型保持绝对一致；多表关联查询时，保证被关联的字段需要有索引。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>即使双表 <code>join</code> 也要注意表索引、SQL 性能。</p></div></li> <li><p>【强制】在 <code>varchar</code> 字段上建立索引时，必须指定索引长度，没必要对全字段建立索引，根据实际文本区分度决定索引长度。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>索引的长度与区分度是一对矛盾体，一般对字符串类型数据，长度为 20 的索引，区分度会高达 90%以上，可以使用<code>count(distinct left(列名, 索引长度))/count(*)</code>的区分度来确定。</p></div></li> <li><p>【强制】页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>索引文件具有 B-Tree 的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索引。</p></div></li> <li><p>【推荐】如果有 <code>order by</code> 的场景，请注意利用索引的有序性。<code>order by</code> 最后的字段是组合索引的一部分，并且放在索引组合顺序的最后，避免出现 <code>file_sort</code> 的情况，影响查询性能。</p> <div class="custom-block tip"><p class="custom-block-title">正例：</p> <p><code>where a=? and b=? order by c; 索引：a_b_c</code></p></div> <div class="custom-block danger"><p class="custom-block-title">反例：</p> <p>索引如果存在范围查询，那么索引有序性无法利用，如：<code>WHERE a&gt;10 ORDER BY b</code>; 索引 <code>a_b</code> 无法排序。</p></div></li> <li><p>【推荐】利用覆盖索引来进行查询操作，避免回表。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>如果一本书需要知道第 11 章是什么标题，会翻开第 11 章对应的那一页吗？目录浏览一下就好，这个目录就是起到覆盖索引的作用。</p></div> <div class="custom-block tip"><p class="custom-block-title">正例：</p> <p>能够建立索引的种类分为主键索引、唯一索引、普通索引三种，而覆盖索引只是一种查询的一种效果，用 explain 的结果，extra 列会出现：using index。</p></div></li> <li><p>【推荐】利用延迟关联或者子查询优化超多分页场景。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>MySQL 并不是跳过 offset 行，而是取 offset+N 行，然后返回放弃前 offset 行，返回 N 行，那当 offset 特别大的时候，效率就非常的低下，要么控制返回的总页数，要么对超过特定阈值的页数进行 SQL 改写。</p></div> <div class="custom-block tip"><p class="custom-block-title">正例：</p> <p>先快速定位需要获取的 id 段，然后再关联：<code>SELECT a.\* FROM 表 1 a, (select id from 表 1 where 条件 LIMIT 100000,20 ) b where a.id=b.id</code></p></div></li> <li><p>【推荐】SQL 性能优化的目标：至少要达到 <code>range</code> 级别，要求是 <code>ref</code> 级别，如果可以是 <code>consts</code> 最好。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>1 ） <code>consts</code> 单表中最多只有一个匹配行（主键或者唯一索引），在优化阶段即可读取到数据。</p> <p>2 ） <code>ref</code> 指的是使用普通的索引（<code>normal index</code>）。</p> <p>3 ） <code>range</code> 对索引进行范围检索。</p></div> <div class="custom-block danger"><p class="custom-block-title">反例：</p> <p><code>explain</code> 表的结果，<code>type=index</code>，索引物理文件全扫描，速度非常慢，这个 <code>index</code> 级别比较 <code>range</code> 还低，与全表扫描是小巫见大巫。</p></div></li> <li><p>【推荐】建组合索引的时候，区分度最高的在最左边。</p> <div class="custom-block tip"><p class="custom-block-title">正例：</p> <p>如果 <code>where a=? and b=?</code>，<code>a</code> 列的几乎接近于唯一值，那么只需要单建 <code>idx_a</code> 索引即可。</p></div> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>存在非等号和等号混合判断条件时，在建索引时，请把等号条件的列前置。如：<code>where c&gt;? and d=?</code> 那么即使 <code>c</code> 的区分度更高，也必须把 <code>d</code> 放在索引的最前列，即建立组合索引 <code>idx_d_c</code>。</p></div></li> <li><p>【推荐】防止因字段类型不同造成的隐式转换，导致索引失效。</p></li> <li><p>【参考】创建索引时避免有如下极端误解：</p> <p>1 ） 索引宁滥勿缺。认为一个查询就需要建一个索引。</p> <p>2 ） 吝啬索引的创建。认为索引会消耗空间、严重拖慢记录的更新以及行的新增速度。</p> <p>3 ） 抵制惟一索引。认为惟一索引一律需要在应用层通过“先查后插”方式解决。</p></li></ol> <h2 id="三-sql-语句"><a href="#三-sql-语句" class="header-anchor">#</a> (三) SQL 语句</h2> <ol><li><p>【强制】不要使用 <code>count(列名)</code> 或 <code>count(常量)</code>来替代 <code>count(*)</code>，<code>count(*)</code>是 SQL92 定义的标
准统计行数的语法，跟数据库无关，跟 <code>NULL</code> 和<code>非 NULL</code> 无关。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p><code>count(*)</code>会统计值为 <code>NULL</code> 的行，而 <code>count(列名)</code>不会统计此列为 <code>NULL</code> 值的行。</p></div></li> <li><p>【强制】<code>count(distinct col)</code> 计算该列除 <code>NULL</code> 之外的不重复行数，注意 <code>count(distinct col1, col2)</code> 如果其中一列全为 <code>NULL</code>，那么即使另一列有不同的值，也返回为 <code>0</code> 。</p></li> <li><p>【强制】当某一列的值全是 <code>NULL</code> 时，<code>count(col)</code>的返回结果为 <code>0</code> ，但 <code>sum(col)</code>的返回结果为 <code>NULL</code>，因此使用 <code>sum()</code> 时需注意 <code>NPE</code> 问题。</p> <div class="custom-block tip"><p class="custom-block-title">正例：</p> <p>可以使用如下方式来避免 <code>sum</code> 的 <code>NPE</code> 问题：<code>SELECT IFNULL(SUM(column), 0) FROM table;</code></p></div></li> <li><p>【强制】使用 <code>ISNULL()</code> 来判断是否为 <code>NULL</code> 值。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p><code>NULL</code> 与任何值的直接比较都为 <code>NULL</code>。</p> <p>1 ） <code>NULL&lt;&gt;NULL</code> 的返回结果是 <code>NULL</code>，而不是 <code>false</code>。</p> <p>2 ） <code>NULL=NULL</code> 的返回结果是 <code>NULL</code>，而不是 <code>true</code>。</p> <p>3 ） <code>NULL&lt;&gt;1</code> 的返回结果是 <code>NULL</code>，而不是 <code>true</code>。</p></div> <div class="custom-block danger"><p class="custom-block-title">反例：</p> <p>在 SQL 语句中，如果在 null 前换行，影响可读性。</p> <p><code>select * from table where column1 is null and column3 is not null;</code></p> <p>而<code>ISNULL(column)</code>是一个整体，简洁易懂。从性能数据上分析，<code>ISNULL(column)</code> 执行效率更快一些。</p></div></li> <li><p>【强制】代码中写分页查询逻辑时，若 <code>count</code> 为 <code>0</code> 应直接返回，避免执行后面的分页语句。</p></li> <li><p>【强制】不得使用外键与级联，一切外键概念必须在应用层解决。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>（概念解释）学生表中的 <code>student_id</code> 是主键，那么成绩表中的 <code>student_id</code> 则为外键。如果更新学生表中的 <code>student_id</code>，同时触发成绩表中的 <code>student_id</code> 更新，即为级联更新。</p> <p>外键与级联更新适用于单机低并发，不适合分布式、高并发集群；</p> <p>级联更新是强阻塞，存在数据库更新风暴的风险；外键影响数据库的插入速度。</p></div></li> <li><p>【强制】禁止使用存储过程，存储过程难以调试和扩展，更没有移植性。</p></li> <li><p>【强制】数据订正（特别是删除或修改记录操作）时，要先 <code>select</code>，避免出现误删除，确认无误才能执行更新语句。</p></li> <li><p>【强制】对于数据库中表记录的查询和变更，只要涉及多个表，都需要在列名前加表的别名（或表名）进行限定。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>对多表进行查询记录、更新记录、删除记录时，如果对操作列没有限定表的别名（或表名），并且操作列在多个表中存在时，就会抛异常。</p></div> <div class="custom-block tip"><p class="custom-block-title">正例：</p> <p><code>select t1.name from table_first as t1 , table_second as t2 where t1.id=t2.id;</code></p></div> <div class="custom-block danger"><p class="custom-block-title">反例：</p> <p>在某业务中，由于多表关联查询语句没有加表的别名（或表名）的限制，正常运行两年后，最近在某个表中增加一个同名字段，在预发布环境做数据库变更后，线上查询语句出现出 1052 异常：<code>Column 'name' in field list is ambiguous</code>。</p></div></li> <li><p>【推荐】SQL 语句中表的别名前加 <code>as</code>，并且以 <code>t1、t2、t3、...</code>的顺序依次命名。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>1 ）别名可以是表的简称，或者是根据表出现的顺序，以 <code>t1、t2、t3</code> 的方式命名。</p> <p>2 ）别名前加 <code>as</code> 使别名更容易识别。</p></div> <div class="custom-block tip"><p class="custom-block-title">正例：</p> <p><code>select t1.name from table_first as t1, table_second as t2 where t1.id=t2.id;</code></p></div></li> <li><p>【推荐】in 操作能避免则避免，若实在避免不了，需要仔细评估 <code>in</code> 后边的集合元素数量，控制在 <code>1000</code> 个之内。</p></li> <li><p>【参考】因国际化需要，所有的字符存储与表示，均采用 <code>utf8</code> 字符集，那么字符计数方法需要注意。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>SELECT LENGTH(&quot;轻松工作&quot;)； 返回为 12</p> <p>SELECT CHARACTER_LENGTH(&quot;轻松工作&quot;)； 返回为 4</p> <p>如果需要存储表情，那么选择 <code>utf8mb4</code> 来进行存储，注意它与 <code>utf8</code> 编码的区别。</p></div></li> <li><p>【参考】<code>TRUNCATE TABLE</code> 比 <code>DELETE</code> 速度快，且使用的系统和事务日志资源少，但 <code>TRUNCATE</code> 无事务且不触发 <code>trigger</code>，有可能造成事故，故不建议在开发代码中使用此语句。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p><code>TRUNCATE TABLE</code> 在功能上与不带 <code>WHERE</code> 子句的 <code>DELETE</code> 语句相同。</p></div></li></ol> <h2 id="四-orm-映射"><a href="#四-orm-映射" class="header-anchor">#</a> (四) ORM 映射</h2> <ol><li><p>【强制】在表查询中，一律不要使用 <code>*</code> 作为查询的字段列表，需要哪些字段必须明确写明。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>1 ）增加查询分析器解析成本。</p> <p>2 ）增减字段容易与 <code>resultMap</code> 配置不一致。</p> <p>3 ）无用字段增加网络消耗，尤其是 <code>text</code> 类型的字段。</p></div></li> <li><p>【强制】POJO 类的布尔属性不能加 <code>is</code>，而数据库字段必须加 <code>is_</code>，要求在 <code>resultMap</code> 中进行字段与属性之间的映射。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>参见定义 POJO 类以及数据库字段定义规定，在 <code>sql.xml</code> 增加映射，是必须的。</p></div></li> <li><p>【强制】不要用 <code>resultClass</code> 当返回参数，即使所有类属性名与数据库字段一一对应，也需要定义<code>&lt;resultMap&gt;</code>；反过来，每一个表也必然有一个<code>&lt;resultMap&gt;</code>与之对应。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>配置映射关系，使字段与 <code>DO</code> 类解耦，方便维护。</p></div></li> <li><p>【强制】sql.xml 配置参数使用：<code>#{}</code>，<code>#param#</code> 不要使用<code>${}</code> 此种方式容易出现 <code>SQL 注入</code>。</p></li> <li><p>【强制】<code>iBATIS</code> 自带的 <code>queryForList(String statementName,int start,int size)</code> 不推荐使用。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>其实现方式是在数据库取到 <code>statementName</code> 对应的 SQL 语句的所有记录，再通过 <code>subList</code> 取 <code>start</code>,<code>size</code> 的子集合。</p></div> <div class="custom-block tip"><p class="custom-block-title">正例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;size&quot;</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div></li> <li><p>【强制】不允许直接拿 <code>HashMap</code> 与 <code>Hashtable</code> 作为查询结果集的输出。</p> <div class="custom-block danger"><p class="custom-block-title">反例：</p> <p>某同学为避免写一个<code>&lt;resultMap&gt;</code>，直接使用 <code>HashTable</code> 来接收数据库返回结果，结果出现日常是把 <code>bigint</code> 转成 <code>Long</code> 值，而线上由于数据库版本不一样，解析成 <code>BigInteger</code>，导致线上问题。</p></div></li> <li><p>【强制】更新数据表记录时，必须同时更新记录对应的 <code>gmt_modified</code> 字段值为当前时间。</p></li> <li><p>【推荐】不要写一个大而全的数据更新接口。传入为 POJO 类，不管是不是自己的目标更新字段，都进行 <code>update table set c1=value1,c2=value2,c3=value3;</code> 这是不对的。</p> <div class="custom-block warning"><p class="custom-block-title">说明：</p> <p>执行 SQL 时，不要更新无改动的字段</p> <ul><li>一是易出错；</li> <li>二是效率低；</li> <li>三是增加 <code>binlog</code> 存储。</li></ul></div></li> <li><p>【参考】<code>@Transactional</code> 事务不要滥用。事务会影响数据库的 QPS，另外使用事务的地方需要考虑各方面的回滚方案，包括<code>缓存回滚</code>、<code>搜索引擎回滚</code>、<code>消息补偿</code>、<code>统计修正</code>等。</p></li> <li><p>【参考】<code>&lt;isEqual&gt;</code>中的 <code>compareValue</code> 是与属性值对比的常量，一般是数字，表示相等时带上此条件；<code>&lt;isNotEmpty&gt;</code>表示不为<code>空</code>且不为 <code>null</code> 时执行；<code>&lt;isNotNull&gt;</code>表示不为 <code>null</code> 值时执行。</p></li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/programmingStyle/java.programming.style/edit/master/alibaba/mysql-database-specification.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020-4-29 09:11:06</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/alibaba/security-specification.html" class="prev">
        四、安全规约
      </a></span> <span class="next"><a href="/alibaba/project-struct-specification.html">
        六、工程结构
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ebef3189.js" defer></script><script src="/assets/js/2.6bb482e9.js" defer></script><script src="/assets/js/12.2916cd62.js" defer></script>
  </body>
</html>
